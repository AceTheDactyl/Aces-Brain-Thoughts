<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ace Neural Codex — Wumbo Engine Runner</title>
  <style>
    :root{--bg:#0b0c10;--panel:#121317;--ink:#e6e7ea;--muted:#a9acb2;--accent:#8ab4f8;--rule:#20222a}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;line-height:1.55}
    .container{max-width:1000px;margin:0 auto;padding:32px 20px}
    .header{padding:24px;border:1px solid var(--rule);border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02))}
    .header h1{margin:0 0 8px}
    .muted{color:var(--muted)}
    .section{margin:28px 0;padding:20px;border:1px solid var(--rule);border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}
    .entry{position:relative;margin:14px 0;padding:12px;border:1px solid var(--rule);border-radius:10px;background:rgba(255,255,255,.02)}
    .entry.collapsed .entry-content{display:none}
    .entry .entry-toggle{position:absolute;top:12px;right:12px;cursor:pointer}
    .btn{display:inline-block;background:var(--accent);color:#0b0c10;font-weight:700;border-radius:8px;padding:8px 12px;border:2px solid #000;cursor:pointer}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .row .btn{margin:6px 0}
    .viewer{min-height:300px;margin-top:12px;padding:16px;border:1px solid var(--rule);border-radius:10px;background:#0e0f14;overflow:auto}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input[type="search"]{flex:1;min-width:220px;padding:8px;border-radius:8px;border:1px solid var(--rule);background:#0f1116;color:var(--ink)}
    .muted-link{color:var(--muted);text-decoration:none}
    .muted-link:hover{color:var(--ink);text-decoration:underline}
    .split{display:flex;gap:16px}
    .pane{flex:1;min-width:0}
    .controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .index-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{padding:6px 10px;border:1px solid var(--rule);border-radius:999px;background:#11121a;color:var(--ink);cursor:pointer}
    mark, .hl{background: #fff176;color:#111;padding:0 2px;border-radius:2px}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Ace Neural Codex – Wumbo Engine</h1>
      <p class="muted">Local runner is live. Operators Manual mode enabled for Tokens Index and Neural Matrix.</p>
    </header>

    <section class="section">
      <h2>Quick Demo</h2>
      <article id="demo-entry" class="entry">
        <div class="entry-toggle" onclick="toggleEntry('demo-entry')">▼</div>
        <h3>Collapsible Entry</h3>
        <div class="entry-content">
          <p>This demonstrates the collapse/expand behavior used across the Wumbo Engine.</p>
        </div>
      </article>
      <button class="btn" onclick="alert('Wumbo Engine runner is active.')">Ping Wumbo</button>
    </section>

    <section class="section">
      <h2>Operators Manual — Token Index & Neural Matrix</h2>
      <p class="muted">Use the controls below to open, search, and cross‑reference the Codex documents. Source files are Markdown and live in this repository.</p>
      <div class="toolbar" style="margin:8px 0 12px">
        <div class="row">
          <button class="btn" onclick="loadDoc('TOKEN_INDEX.md')">Open Token Index</button>
          <button class="btn" onclick="loadDoc('NEURAL_PATHING_MATRIX.md')">Open Neural Pathing Matrix</button>
        </div>
        <input id="searchBox" type="search" placeholder="Search in document… (press Enter)" onkeydown="if(event.key==='Enter'){searchInViewer()}" />
        <a class="muted-link" href="TOKEN_INDEX.md" target="_blank">Raw Token Index</a>
        <span>·</span>
        <a class="muted-link" href="NEURAL_PATHING_MATRIX.md" target="_blank">Raw Neural Matrix</a>
      </div>
      <div class="controls">
        <button class="btn" onclick="toggleSplit()" id="splitBtn">Enable Split View</button>
        <button class="btn" onclick="findPrev()">Find Prev</button>
        <button class="btn" onclick="findNext()">Find Next</button>
        <button class="btn" onclick="clearHighlights()">Clear Highlights</button>
        <label><input type="checkbox" id="syncSearch" checked /> Sync search to other pane</label>
      </div>
      <div id="quickIndex" class="index-list"></div>
      <div id="splitContainer" class="split" style="display:none">
        <div class="pane">
          <h3>Primary</h3>
          <div id="viewer" class="viewer"><em class="muted">Select a document to begin.</em></div>
        </div>
        <div class="pane" id="paneB" style="display:none">
          <h3>Secondary</h3>
          <div id="viewerB" class="viewer"><em class="muted">Load a second document or enable auto‑sync.</em></div>
        </div>
      </div>
      <div id="singleContainer">
        <div id="viewer_single" class="viewer" style="display:block"><em class="muted">Select a document to begin.</em></div>
      </div>
    </section>

    <section class="section">
      <h2>Next Steps</h2>
      <ol>
        <li>Open the Token Index or Neural Matrix using the buttons above.</li>
        <li>Use the search box to find regions, phases, or pathways.</li>
        <li>Publish updates by pushing to <code>main</code>; GitHub Pages deploys automatically.</li>
      </ol>
      <p class="muted">Tip: The raw Markdown links are handy for quick diffs and PR reviews.</p>
    </section>
  </div>

  <!-- Markdown rendering (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.9/dist/purify.min.js"></script>
  <script>
    let lastDocPath = null;     // primary
    let lastDocText = '';
    let lastDocPathB = null;    // secondary
    let lastDocTextB = '';
    let split = false;
    let lastSearch = '';
    let lastFoundNode = null;

    function toggleEntry(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle('collapsed');
    }

    function slugify(text){
      return (text||'').toLowerCase()
        .replace(/[^a-z0-9\s\-_.]/g,'')
        .replace(/\s+/g,'-')
        .replace(/-+/g,'-')
        .replace(/^-|-$|\.+$/g,'');
    }

    function renderMarkdownTo(elId, md){
      const html = DOMPurify.sanitize(marked.parse(md));
      const el = document.getElementById(elId);
      el.innerHTML = html;
      return el;
    }

    function postProcessTokenIndex(el){
      // Add anchors to bold region headers like: **V. Broca's Area** — ...
      const strongs = el.querySelectorAll('p > strong');
      let chips = [];
      strongs.forEach(s => {
        const t = s.textContent.trim();
        const m = t.match(/^([IVXLCDM]+)\.?\s+([^*—\-]+)/);
        if(m){
          const roman = m[1];
          const name = m[2].trim();
          const id = 'token-' + slugify(roman + '-' + name);
          // Insert anchor
          if(!el.querySelector('#'+id)){
            const a = document.createElement('a');
            a.id = id;
            s.parentElement.parentElement.insertBefore(a, s.parentElement);
          }
          chips.push({id, label: roman+'. '+name, query: name});
        }
      });
      // Render quick index chips
      const qi = document.getElementById('quickIndex');
      qi.innerHTML = '';
      chips.slice(0, 40).forEach(({id,label,query}) => {
        const c = document.createElement('button');
        c.className = 'chip';
        c.textContent = label;
        c.title = 'Jump to '+label;
        c.onclick = () => {
          // Scroll primary
          const anchor = el.querySelector('#'+id);
          if(anchor){ anchor.scrollIntoView({behavior:'smooth', block:'start'}); }
          // If split and sync, search other pane by name
          if(split && document.getElementById('syncSearch').checked){
            const q = query;
            if(lastDocPathB){
              doSearchIn('viewerB', q, true);
            } else {
              // Auto-load the other doc
              if(lastDocPath && lastDocPath.includes('TOKEN_INDEX')){
                loadDoc('NEURAL_PATHING_MATRIX.md', true, q);
              }else{
                loadDoc('TOKEN_INDEX.md', true, q);
              }
            }
          }
        };
        qi.appendChild(c);
      });
    }

    async function loadDoc(path, toSecondary=false, postSearch=null){
      try{
        const res = await fetch(path, {cache:'no-cache'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const md = await res.text();
        if(split){
          if(toSecondary){
            lastDocPathB = path; lastDocTextB = md;
            renderMarkdownTo('viewerB', md);
            if(postSearch){ doSearchIn('viewerB', postSearch, true); }
          }else{
            lastDocPath = path; lastDocText = md;
            renderMarkdownTo('viewer', md);
            if(path.includes('TOKEN_INDEX')){ postProcessTokenIndex(document.getElementById('viewer')); }
            if(postSearch){ doSearchIn('viewer', postSearch, true); }
          }
        }else{
          lastDocPath = path; lastDocText = md;
          renderMarkdownTo('viewer_single', md);
          if(path.includes('TOKEN_INDEX')){ postProcessTokenIndex(document.getElementById('viewer_single')); }
          if(postSearch){ doSearchIn('viewer_single', postSearch, true); }
        }
        // Reset search box
        const sb = document.getElementById('searchBox');
        if (sb) sb.value = '';
        // Scroll to top
        window.scrollTo({top:0, behavior:'smooth'});
      }catch(err){
        const target = split ? (toSecondary ? 'viewerB' : 'viewer') : 'viewer_single';
        document.getElementById(target).innerHTML = '<p style="color:#ff8080">Failed to load '+path+': '+err.message+'</p>';
      }
    }

    function elementsForSearch(){
      if(split){
        return [document.getElementById('viewer'), document.getElementById('viewerB')].filter(Boolean);
      }
      return [document.getElementById('viewer_single')];
    }

    function clearHighlights(){
      elementsForSearch().forEach(el => {
        el.querySelectorAll('mark.hl').forEach(m => {
          const text = document.createTextNode(m.textContent);
          m.parentNode.replaceChild(text, m);
        });
      });
      lastFoundNode = null;
    }

    function highlightAll(el, q){
      if(!q) return;
      const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, null);
      const lower = q.toLowerCase();
      let node;
      const toWrap = [];
      while(node = walker.nextNode()){
        const text = node.nodeValue;
        const idx = text.toLowerCase().indexOf(lower);
        if(idx !== -1){ toWrap.push({node, idx}); }
      }
      toWrap.forEach(({node, idx}) => {
        const range = document.createRange();
        range.setStart(node, idx);
        range.setEnd(node, idx + q.length);
        const mark = document.createElement('mark');
        mark.className = 'hl';
        range.surroundContents(mark);
      });
    }

    function doSearchIn(viewerId, q, center=false){
      const el = document.getElementById(viewerId);
      if(!el) return false;
      clearHighlights();
      highlightAll(el, q);
      // Focus first match
      const first = el.querySelector('mark.hl');
      if(first){
        const r = document.createRange();
        r.selectNodeContents(first);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(r);
        if(center){
          const rect = first.getBoundingClientRect();
          const top = rect.top + window.scrollY - 120;
          window.scrollTo({top, behavior:'smooth'});
        }
        return true;
      }
      return false;
    }

    function searchInViewer(){
      const q = (document.getElementById('searchBox')?.value || '').trim();
      if(!q){return}
      lastSearch = q;
      const ok = doSearchIn(split ? 'viewer' : 'viewer_single', q, true);
      if(split && document.getElementById('syncSearch').checked){
        doSearchIn('viewerB', q, false);
      }
      if(!ok){ /* no-op */ }
    }

    function findNext(){
      const q = lastSearch || (document.getElementById('searchBox')?.value || '').trim();
      if(!q) return;
      // move to next highlight
      const el = split ? document.getElementById('viewer') : document.getElementById('viewer_single');
      const marks = el.querySelectorAll('mark.hl');
      if(marks.length === 0){ doSearchIn(el.id, q, true); return; }
      let idx = 0;
      if(lastFoundNode){
        idx = Array.from(marks).indexOf(lastFoundNode) + 1;
        if(idx >= marks.length) idx = 0;
      }
      const m = marks[idx];
      lastFoundNode = m;
      const r = document.createRange(); r.selectNodeContents(m);
      const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(r);
      const rect = m.getBoundingClientRect();
      window.scrollBy({top: rect.top - 120, behavior:'smooth'});
      if(split && document.getElementById('syncSearch').checked){
        doSearchIn('viewerB', q, false);
      }
    }

    function findPrev(){
      const q = lastSearch || (document.getElementById('searchBox')?.value || '').trim();
      if(!q) return;
      const el = split ? document.getElementById('viewer') : document.getElementById('viewer_single');
      const marks = el.querySelectorAll('mark.hl');
      if(marks.length === 0){ doSearchIn(el.id, q, true); return; }
      let idx = marks.length - 1;
      if(lastFoundNode){
        idx = Array.from(marks).indexOf(lastFoundNode) - 1;
        if(idx < 0) idx = marks.length - 1;
      }
      const m = marks[idx];
      lastFoundNode = m;
      const r = document.createRange(); r.selectNodeContents(m);
      const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(r);
      const rect = m.getBoundingClientRect();
      window.scrollBy({top: rect.top - 120, behavior:'smooth'});
      if(split && document.getElementById('syncSearch').checked){
        doSearchIn('viewerB', q, false);
      }
    }

    function toggleSplit(){
      split = !split;
      const splitEl = document.getElementById('splitContainer');
      const singleEl = document.getElementById('singleContainer');
      const paneB = document.getElementById('paneB');
      const btn = document.getElementById('splitBtn');
      if(split){
        splitEl.style.display = 'flex';
        singleEl.style.display = 'none';
        paneB.style.display = 'block';
        btn.textContent = 'Disable Split View';
        // populate viewer from single if present
        if(lastDocText){
          renderMarkdownTo('viewer', lastDocText);
          if(lastDocPath && lastDocPath.includes('TOKEN_INDEX')){ postProcessTokenIndex(document.getElementById('viewer')); }
        }
        // auto-load the counterpart doc
        if(lastDocPath){
          const other = lastDocPath.includes('TOKEN_INDEX') ? 'NEURAL_PATHING_MATRIX.md' : 'TOKEN_INDEX.md';
          loadDoc(other, true);
        }
      }else{
        splitEl.style.display = 'none';
        singleEl.style.display = 'block';
        btn.textContent = 'Enable Split View';
        // sync content back to single
        const base = document.getElementById('viewer');
        document.getElementById('viewer_single').innerHTML = base ? base.innerHTML : '<em class="muted">Select a document to begin.</em>';
        // reset secondary
        lastDocPathB = null; lastDocTextB = '';
      }
    }
  </script>
</body>
</html>
